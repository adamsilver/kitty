<!DOCTYPE html>
<html>
    <head>
        <title>Calendar Week View Demo</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta name="Author" content="Adam Silver">
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
        <style>

            table, td, th {
                margin: 0;
                padding: 0;
            }

            body {
                font-family: arial;
            }

            .calendarWeekView {
                padding: 10px;
            }

            .calendarWeekView table {
                width: 100%;
                table-layout: fixed;
                border: 1px solid #ccc;
                border-collapse: collapse;
            }

            .calendarWeekView caption {
                border: 1px solid #444;
                border-bottom: none;
                padding: 10px;
                background-color: #444;
                color: #fff;
            }

            .calendarWeekView thead th {
                padding: 10px;
            }

            .calendarWeekView th,
            .calendarWeekView td {
                border: 1px solid #ccc;
                font-weight: normal;
                vertical-align: top;
                position: relative;
            }

            .calendarWeekView-times {
                text-align: right;
                position: relative;
            }

            .calendarWeekView-time {
                height: 56px;
                padding-right: 3px;
                padding-top: 3px;
                border-bottom: 1px solid #ccc;
            }

            .calendarWeekView-entries {
                position: absolute;
                height: 100%;
                width: 100%;
                background-color: #eee;
            }

            .calendarWeekView-entry {
                background-color: #ff0;
                position: absolute;
                width: 100%;
                z-index: 100;
            }
        </style>
    </head>
    <body>
        <h1>Calendar Week View</h1>
        <ul>
            <li><a href="month-view.html">Month View</a></li>
            <li><a href="week-view.html">Week View</a></li>
        </ul>

        <div class="calendarWeekView">
            <table>
                <caption>January 9-15, 2016</caption>
                <thead>
                    <tr>
                        <th></th>
                        <th scope="col" abbr="Monday">Mon 9</th>
                        <th scope="col" abbr="Tuesday">Tue 10</th>
                        <th scope="col" abbr="Wednesday">Wed 11</th>
                        <th scope="col" abbr="Thursday">Thu 12</th>
                        <th scope="col" abbr="Friday">Fri 13</th>
                        <th scope="col" abbr="Saturday">Sat 14</th>
                        <th scope="col" abbr="Sunday">Sun 15</th>
                </thead>
                <tbody>
                    <tr>
                        <th class="calendarWeekView-times">
                            <div class="calendarWeekView-time" data-time="0900">09:00</div>
                            <div class="calendarWeekView-time" data-time="1000">10:00</div>
                            <div class="calendarWeekView-time" data-time="1100">11:00</div>
                            <div class="calendarWeekView-time" data-time="1200">12:00</div>
                            <div class="calendarWeekView-time" data-time="1300">13:00</div>
                            <div class="calendarWeekView-time" data-time="1400">14:00</div>
                            <div class="calendarWeekView-time" data-time="1500">15:00</div>
                            <div class="calendarWeekView-time" data-time="1600">16:00</div>
                            <div class="calendarWeekView-time" data-time="1700">17:00</div>
                        </th>
                        <td>
                            <div class="calendarWeekView-entries">
                                <div 
                                    class="calendarWeekView-entry" 
                                    data-start-time="1000" data-end-time="1030" data-duration="30">
                                    Event #1 (10:00-10:30)
                                </div>
                                <div 
                                    class="calendarWeekView-entry" 
                                    data-start-time="1400" data-end-time="1530" data-duration="90">
                                    Event #2 (14:00-15:30)
                                </div>
                            </div>
                        </td>
                        <td><div class="calendarWeekView-entries">2</div></td>
                        <td><div class="calendarWeekView-entries">3</div></td>
                        <td><div class="calendarWeekView-entries">4</div></td>
                        <td><div class="calendarWeekView-entries">5</div></td>
                        <td><div class="calendarWeekView-entries">6</div></td>
                        <td><div class="calendarWeekView-entries">7</div></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <script type="text/javascript" src="../../vendor/jQuery/jQuery.js"></script>
        <script type="text/javascript" src="../../vendor/jQueryUI/jquery-ui.js"></script>
        <script>

            function WeekView(container) {
                this.container = container;
                this.timeSlots = container.find('.calendarWeekView-time')
                this.entriesContainer = container.find('.calendarWeekView-entries');
                this.entries = container.find('.calendarWeekView-entry');
                this.positionEntries();
                this.sizeEntries();
                this.createDraggables();
                this.createDroppables();
            }

            WeekView.prototype.positionEntries = function() {
                this.entries.each(function(i, el) {
                    this.positionEntry($(el));
                }.bind(this));
            };

            WeekView.prototype.positionEntry = function(entry) {
                var slot = this.getTimeSlotByTimeAttribute(entry.attr('data-start-time'));
                var position = slot.position();
                entry.css('top', position.top+'px');
            };

            WeekView.prototype.sizeEntries = function() {
                this.entries.each(function(i, el) {
                    this.sizeEntry($(el));
                }.bind(this));
            };



            WeekView.prototype.sizeEntry = function(entry) {
                var timeSlotHeight = 56;
                var duration = this.getDurationInMinsOfEntry(entry);
                var hours = duration / 60;
                var height = hours * timeSlotHeight;
                entry.css('height', height);
            };

            WeekView.prototype.getDurationInMinsOfEntry = function(entry) {
                return parseInt(entry.attr('data-duration'), 10);
            };

            WeekView.prototype.getTimeSlotByTimeAttribute = function(time) {
                var $el;
                this.timeSlots.each(function(i, el) {
                    if($(el).attr('data-time') === time) {
                        $el = $(el);
                    }
                });
                return $el;
            };

            WeekView.prototype.createDraggables = function() {
                this.entries.draggable({
                    containment: this.container,
                    revert: 'invalid',
                    snap: '.calendarWeekView-entries',
                    snapMode: 'inner',
                    grid: [176, 10],
                    stop: $.proxy(this, 'onEntryFinishedDragging')
                });
                this.entries.droppable({
                    greedy: true,
                    tolerance: 'touch',
                    drop: function(e, ui){
                        // after dropping making sure the revert is set to true
                        // so that it never allows dragging on to the droppable
                        ui.draggable.draggable('option','revert',true);
                    }
                });
            };

            WeekView.prototype.onEntryFinishedDragging = function(e, ui) {
                $(e.target).draggable('option','revert','invalid');

                // TODO
                // work out where the new entry is and set the times.

                console.log(ui);
                this.getStartTimeFromOffsetTop(ui.position.top);
            };

            WeekView.prototype.getStartTimeFromOffsetTop = function(top) {
                console.log(9+top/60);
            };

            WeekView.prototype.createDroppables = function() {
                this.entriesContainer.droppable({
                    accept: '.calendarWeekView-entry'
                });
            };

            new WeekView($('.calendarWeekView'));

        </script>
    </body>
</html>